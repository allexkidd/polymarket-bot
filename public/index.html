<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Sniper Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      background: #0a0a0f;
      color: #fff;
      min-height: 100vh;
      padding: 16px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2d2d44;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, #8b5cf6, #06b6d4);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .title {
      font-size: 20px; font-weight: bold;
      background: linear-gradient(90deg, #a78bfa, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { color: #6b7280; font-size: 10px; margin-top: 2px; }
    .status-dot {
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      margin-right: 4px;
    }
    .status-dot.running { background: #10b981; animation: pulse 2s infinite; }
    .status-dot.stopped { background: #6b7280; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .controls { display: flex; gap: 8px; }
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      transition: all 0.2s;
    }
    .btn-start { background: #10b98130; color: #10b981; border: 1px solid #10b98150; }
    .btn-stop { background: #ef444430; color: #ef4444; border: 1px solid #ef444450; }
    .btn-secondary { background: #6b728030; color: #9ca3af; border: 1px solid #6b728050; }
    .btn:hover { filter: brightness(1.2); }
    
    .time-box {
      background: linear-gradient(135deg, #1e1e2e, #12121a);
      border: 1px solid #3d3d54;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    .current-time {
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(90deg, #22d3ee, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .window-info {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 10px;
      font-size: 11px;
    }
    .window-label { color: #6b7280; font-size: 9px; text-transform: uppercase; }
    .window-value { color: #fff; font-weight: bold; margin-top: 2px; }
    .countdown { font-size: 22px; font-weight: bold; margin-top: 6px; }
    .slugs-box {
      background: #0a0a0f;
      border-radius: 6px;
      padding: 8px;
      margin-top: 10px;
      text-align: left;
    }
    .slug-chip {
      display: inline-block;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 9px;
      font-family: monospace;
      margin: 2px;
    }
    .slug-traded { background: #22c55e30; color: #22c55e; border: 1px solid #22c55e60; }
    .slug-pending { background: #3b82f620; color: #3b82f6; border: 1px solid #3b82f640; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .stat {
      background: #12121a;
      border: 1px solid #2d2d44;
      border-radius: 8px;
      padding: 10px;
    }
    .stat-label { font-size: 9px; color: #6b7280; text-transform: uppercase; }
    .stat-value { font-size: 14px; font-weight: bold; margin-top: 2px; }
    
    .section {
      background: #12121a;
      border: 1px solid #2d2d44;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 12px;
      font-weight: bold;
    }
    .input {
      width: 100%;
      background: #0a0a0f;
      border: 1px solid #2d2d44;
      border-radius: 6px;
      padding: 8px;
      color: #fff;
      font-family: inherit;
      font-size: 11px;
    }
    .input:disabled { opacity: 0.5; }
    
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .four-col { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    
    .panel {
      background: #12121a;
      border: 1px solid #2d2d44;
      border-radius: 10px;
      overflow: hidden;
    }
    .panel-header {
      padding: 10px 12px;
      border-bottom: 1px solid #2d2d44;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }
    .panel-content { max-height: 250px; overflow-y: auto; }
    
    .market-card {
      padding: 10px 12px;
      border-bottom: 1px solid #2d2d44;
    }
    .market-card.traded { background: #22c55e08; }
    .market-card.ready { background: #f59e0b10; }
    .market-header { display: flex; justify-content: space-between; align-items: center; }
    .market-crypto { font-size: 16px; font-weight: bold; }
    .market-side { font-size: 11px; margin-left: 8px; }
    .market-side.up { color: #10b981; }
    .market-side.down { color: #ef4444; }
    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: bold;
    }
    .badge-traded { background: #22c55e20; color: #22c55e; }
    .badge-ready { background: #f59e0b30; color: #f59e0b; }
    .badge-watching { background: #3b82f620; color: #3b82f6; }
    .badge-monitoring { background: #6b728020; color: #6b7280; }
    .market-stats { display: flex; gap: 12px; margin-top: 6px; font-size: 10px; color: #9ca3af; }
    
    .trade-card { padding: 10px 12px; border-bottom: 1px solid #2d2d44; }
    
    .log-entry { padding: 3px 12px; font-size: 10px; border-bottom: 1px solid #1a1a2e; }
    .log-entry.info { color: #6b7280; }
    .log-entry.success { color: #10b981; }
    .log-entry.warning { color: #f59e0b; }
    .log-entry.error { color: #ef4444; }
    .log-entry.trade { color: #a78bfa; }
    
    .empty-state { padding: 20px; text-align: center; color: #6b7280; font-size: 11px; }
    
    .footer {
      margin-top: 12px;
      padding: 10px;
      background: #22d3ee10;
      border: 1px solid #22d3ee30;
      border-radius: 8px;
      font-size: 10px;
      color: #22d3ee;
    }
    
    label { display: block; font-size: 8px; color: #6b7280; margin-bottom: 4px; text-transform: uppercase; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">‚ö°</div>
        <div>
          <div class="title">Polymarket Sniper</div>
          <div class="subtitle">
            <span class="status-dot stopped" id="status-dot"></span>
            <span id="status-label">Stopped</span>
          </div>
        </div>
      </div>
      <div class="controls">
        <button class="btn btn-secondary" onclick="resetTrades()">Reset</button>
        <button class="btn btn-secondary" onclick="testTelegram()">Test TG</button>
        <button class="btn btn-start" id="start-btn" onclick="startBot()">‚ñ∂ Start</button>
        <button class="btn btn-stop" id="stop-btn" onclick="stopBot()" style="display:none">‚èπ Stop</button>
      </div>
    </header>

    <!-- Time Display -->
    <div class="time-box">
      <div class="current-time" id="current-time">--:--:--</div>
      <div class="window-info">
        <div>
          <div class="window-label">Window End</div>
          <div class="window-value" id="window-end">--:--:--</div>
        </div>
        <div>
          <div class="window-label">Time Remaining</div>
          <div class="countdown" id="countdown">--</div>
        </div>
        <div>
          <div class="window-label">Server</div>
          <div class="window-value" id="server-time">--:--:--</div>
        </div>
      </div>
      <div class="slugs-box">
        <div style="font-size:9px;color:#6b7280;margin-bottom:4px">ACTIVE MARKET SLUGS:</div>
        <div id="current-slugs"></div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="stat-label">Markets</div>
        <div class="stat-value" style="color:#a78bfa" id="stat-markets">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Traded</div>
        <div class="stat-value" style="color:#22c55e" id="stat-traded">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Total Trades</div>
        <div class="stat-value" style="color:#22d3ee" id="stat-total">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Volume</div>
        <div class="stat-value" style="color:#10b981" id="stat-volume">$0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Wallet</div>
        <div class="stat-value" style="color:#6b7280" id="stat-wallet">None</div>
      </div>
    </div>

    <!-- Wallet & Settings -->
    <div class="two-col">
      <div class="section">
        <div class="section-header">üëõ Wallet</div>
        <div style="display:flex;gap:8px">
          <input type="password" id="private-key" class="input" placeholder="Private key (64 hex characters)" style="flex:1">
          <button class="btn btn-secondary" onclick="toggleKeyVisibility()">üëÅ</button>
          <button class="btn btn-secondary" onclick="connectWallet()">Connect</button>
        </div>
        <div id="wallet-info" style="margin-top:6px;font-size:10px;color:#6b7280"></div>
      </div>
      
      <div class="section">
        <div class="section-header">‚öôÔ∏è Settings</div>
        <div class="four-col">
          <div>
            <label>Prob %</label>
            <input type="number" id="setting-prob" class="input" value="95">
          </div>
          <div>
            <label>Time (s)</label>
            <input type="number" id="setting-time" class="input" value="60">
          </div>
          <div>
            <label>Amount $</label>
            <input type="number" id="setting-amount" class="input" value="10">
          </div>
          <div>
            <label>Poll (ms)</label>
            <input type="number" id="setting-poll" class="input" value="2000">
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Cryptos (comma-separated)</label>
          <input type="text" id="setting-cryptos" class="input" value="btc, eth, sol, xrp">
        </div>
        <button class="btn btn-secondary" style="margin-top:8px" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

    <!-- Markets & Trades -->
    <div class="two-col">
      <div class="panel">
        <div class="panel-header">üìä Live Markets</div>
        <div class="panel-content" id="markets-list">
          <div class="empty-state">No markets loaded</div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header">üìà Trades</div>
        <div class="panel-content" id="trades-list">
          <div class="empty-state">No trades yet</div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="panel">
      <div class="panel-header">
        <span>üîî Activity Log</span>
        <button class="btn btn-secondary" style="padding:4px 8px;font-size:10px" onclick="clearLogs()">Clear</button>
      </div>
      <div class="panel-content" id="logs-list" style="max-height:150px">
        <div class="empty-state">No activity</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <strong>‚ú® Auto-Discovery:</strong> Markets are automatically found based on current time. 
      Pattern: <code style="background:#0a0a0f;padding:2px 4px;border-radius:3px">{crypto}-updown-15m-{timestamp}</code>
    </div>
  </div>

  <script>
    let state = {};
    let showKey = false;

    // Fetch state from server
    async function fetchState() {
      try {
        const res = await fetch('/api/state');
        state = await res.json();
        updateUI();
      } catch (e) {
        console.error('Failed to fetch state:', e);
      }
    }

    function updateUI() {
      // Status
      const dot = document.getElementById('status-dot');
      const label = document.getElementById('status-label');
      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');
      
      if (state.isRunning) {
        dot.className = 'status-dot running';
        label.textContent = 'Running';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
      } else {
        dot.className = 'status-dot stopped';
        label.textContent = 'Stopped';
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
      }

      // Time
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString();
      document.getElementById('server-time').textContent = state.serverTime ? new Date(state.serverTime).toLocaleTimeString() : '--';
      
      if (state.endTimestamp) {
        const endDate = new Date(state.endTimestamp * 1000);
        document.getElementById('window-end').textContent = endDate.toLocaleTimeString();
        
        const countdown = document.getElementById('countdown');
        const timeLeft = Math.max(0, state.timeToEnd);
        const mins = Math.floor(timeLeft / 60);
        const secs = Math.floor(timeLeft % 60);
        countdown.textContent = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        countdown.style.color = timeLeft <= 60 ? '#f59e0b' : '#10b981';
      }

      // Slugs
      const slugsDiv = document.getElementById('current-slugs');
      if (state.currentSlugs) {
        slugsDiv.innerHTML = state.currentSlugs.map(slug => {
          const traded = state.tradedSlugs?.includes(slug);
          return `<span class="slug-chip ${traded ? 'slug-traded' : 'slug-pending'}">${traded ? '‚úì ' : ''}${slug}</span>`;
        }).join('');
      }

      // Stats
      document.getElementById('stat-markets').textContent = state.markets?.length || 0;
      document.getElementById('stat-traded').textContent = state.tradedSlugs?.length || 0;
      document.getElementById('stat-total').textContent = state.stats?.totalTrades || 0;
      document.getElementById('stat-volume').textContent = '$' + (state.stats?.totalVolume || 0);
      document.getElementById('stat-wallet').textContent = state.walletAddress 
        ? state.walletAddress.slice(0,4) + '...' + state.walletAddress.slice(-3)
        : 'None';
      document.getElementById('stat-wallet').style.color = state.walletAddress ? '#10b981' : '#6b7280';

      // Markets
      const marketsList = document.getElementById('markets-list');
      if (state.markets?.length > 0) {
        marketsList.innerHTML = state.markets.map(m => {
          const traded = state.tradedSlugs?.includes(m.slug);
          const meetsProb = m.highProb >= (state.settings?.probabilityThreshold || 0.95);
          const meetsTime = m.timeRemaining > 0 && m.timeRemaining <= (state.settings?.timeThresholdSeconds || 60);
          
          let badgeClass = 'badge-monitoring';
          let badgeText = 'Monitoring';
          let cardClass = '';
          
          if (traded) {
            badgeClass = 'badge-traded'; badgeText = '‚úì TRADED'; cardClass = 'traded';
          } else if (meetsProb && meetsTime) {
            badgeClass = 'badge-ready'; badgeText = 'üî• TRADE!'; cardClass = 'ready';
          } else if (meetsProb) {
            badgeClass = 'badge-watching'; badgeText = 'Watching';
          }
          
          return `
            <div class="market-card ${cardClass}">
              <div class="market-header">
                <div>
                  <span class="market-crypto">${m.crypto}</span>
                  <span class="market-side ${m.highProbSide.toLowerCase()}">${m.highProbSide} ${(m.highProb * 100).toFixed(1)}%</span>
                </div>
                <span class="badge ${badgeClass}">${badgeText}</span>
              </div>
              <div class="market-stats">
                <span>‚¨Ü ${(m.upPrice * 100).toFixed(1)}%</span>
                <span>‚¨á ${(m.downPrice * 100).toFixed(1)}%</span>
                <span style="color:${meetsTime ? '#f59e0b' : '#9ca3af'}">‚è± ${formatTime(m.timeRemaining)}${meetsTime ? ' ‚úì' : ''}</span>
              </div>
            </div>
          `;
        }).join('');
      } else {
        marketsList.innerHTML = '<div class="empty-state">No markets loaded. Start the bot.</div>';
      }

      // Trades
      const tradesList = document.getElementById('trades-list');
      if (state.trades?.length > 0) {
        tradesList.innerHTML = state.trades.slice(0, 20).map(t => `
          <div class="trade-card">
            <div class="market-header">
              <span style="font-weight:bold">${t.crypto} ${t.side}</span>
              <span class="badge badge-traded">‚úì</span>
            </div>
            <div style="font-size:10px;color:#6b7280;margin-top:4px">
              ${(t.price * 100).toFixed(1)}% | $${t.amount} | ${t.timeRemaining.toFixed(1)}s
            </div>
          </div>
        `).join('');
      } else {
        tradesList.innerHTML = '<div class="empty-state">No trades yet</div>';
      }

      // Logs
      const logsList = document.getElementById('logs-list');
      if (state.logs?.length > 0) {
        logsList.innerHTML = state.logs.slice(0, 50).map(l => `
          <div class="log-entry ${l.type}">[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}</div>
        `).join('');
      }
    }

    function formatTime(sec) {
      if (sec <= 0) return 'Closed';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return m > 0 ? `${m}m ${s}s` : `${s}s`;
    }

    function toggleKeyVisibility() {
      showKey = !showKey;
      document.getElementById('private-key').type = showKey ? 'text' : 'password';
    }

    async function connectWallet() {
      const key = document.getElementById('private-key').value;
      if (!key) return alert('Enter private key');
      
      try {
        const res = await fetch('/api/wallet/connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ privateKey: key })
        });
        const data = await res.json();
        
        if (data.success) {
          document.getElementById('wallet-info').innerHTML = 
            `<span style="color:#10b981">‚úì ${data.address}</span><br>` +
            `MATIC: ${parseFloat(data.balances.matic).toFixed(4)} | USDC: ${parseFloat(data.balances.usdc).toFixed(2)}`;
          alert('Wallet connected!');
        } else {
          alert('Error: ' + data.error);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function saveSettings() {
      const settings = {
        probabilityThreshold: parseFloat(document.getElementById('setting-prob').value) / 100,
        timeThresholdSeconds: parseInt(document.getElementById('setting-time').value),
        tradeAmountUsdc: parseFloat(document.getElementById('setting-amount').value),
        pollIntervalMs: parseInt(document.getElementById('setting-poll').value),
        cryptos: document.getElementById('setting-cryptos').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
      };
      
      await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ settings })
      });
      alert('Settings saved!');
    }

    async function startBot() {
      await fetch('/api/bot/start', { method: 'POST' });
    }

    async function stopBot() {
      await fetch('/api/bot/stop', { method: 'POST' });
    }

    async function resetTrades() {
      if (confirm('Reset all traded markets?')) {
        await fetch('/api/bot/reset', { method: 'POST' });
      }
    }

    async function testTelegram() {
      const res = await fetch('/api/telegram/test', { method: 'POST' });
      const data = await res.json();
      alert(data.success ? 'Telegram test sent!' : 'Telegram failed - check settings');
    }

    function clearLogs() {
      document.getElementById('logs-list').innerHTML = '<div class="empty-state">Logs cleared</div>';
    }

    // Load settings from state
    function loadSettings() {
      if (state.settings) {
        document.getElementById('setting-prob').value = (state.settings.probabilityThreshold * 100).toFixed(0);
        document.getElementById('setting-time').value = state.settings.timeThresholdSeconds;
        document.getElementById('setting-amount').value = state.settings.tradeAmountUsdc;
        document.getElementById('setting-poll').value = state.settings.pollIntervalMs;
        document.getElementById('setting-cryptos').value = state.settings.cryptos.join(', ');
      }
    }

    // Initial load
    fetchState().then(loadSettings);
    setInterval(fetchState, 1000);
  </script>
</body>
</html>
